generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  INSTRUCTOR
  ADMIN
  SUPER_ADMIN
  @@map("user_role")
}

model User {
  id            String   @id @db.VarChar(50)
  email         String   @unique @db.VarChar(255)
  name          String   @db.VarChar(150)
  passwordHash  String   @map("password_hash") @db.VarChar(255)
  dni           String?  @db.VarChar(20)
  role          UserRole
  permissions   Json?    @default("{}")
  isActive      Boolean? @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  availabilityVersions AvailabilityVersion[]

  @@index([email], map: "idx_users_email")
  @@index([role], map: "idx_users_role")
  @@map("users")
}

model AcademicPeriod {
  id                  String   @id @db.VarChar(20)
  name                String   @db.VarChar(100)
  startDate           DateTime @map("start_date") @db.Date
  endDate             DateTime @map("end_date") @db.Date
  isActive            Boolean? @default(false) @map("is_active")
  isOpenForSubmission Boolean? @default(false) @map("is_open_for_submission")

  availabilityVersions AvailabilityVersion[]

  // Note: There is a partial unique index on (isActive) where isActive=true in the DB.
  // Prisma doesn't fully represent partial indexes in the schema DSL for all versions, 
  // but it validates against it at the DB level.

  @@map("academic_periods")
}

model AvailabilityVersion {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  instructorId String   @map("instructor_id") @db.VarChar(50)
  periodId     String   @map("period_id") @db.VarChar(20)
  slots        Json
  comments     String?  @db.Text
  isFinal      Boolean? @default(false) @map("is_final")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz

  instructor User           @relation(fields: [instructorId], references: [id], onDelete: Restrict)
  period     AcademicPeriod @relation(fields: [periodId], references: [id])

  @@index([instructorId, periodId], map: "idx_avail_instructor_period")
  @@index([periodId, isFinal], map: "idx_avail_final_reporting")
  @@map("availability_versions")
}
